<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />

</head>

<body>
    <form>
        <button type="button" onclick="onButtonClick()">搜索蓝牙设备</button><br>
        <label>wifi名称(SSID)     </label>:<input type="text" placeholder="请输入wifi名称" name="ssid" id="ssid"> <br>
        <label>wifi密码(Passsword):</label><input type="password" placeholder="请输入wifi密码" name="pwd" id="pwd"><br>
        <button type="button" onclick="connectWifi()">连接</button><br>
        <label>ip地址:</label><label id="ipAddr"></label><br>
        <button type="button" onclick="getIPAddr()">获取ip地址</button><br>
    </form>

</body>

<script>
function onButtonClick() {

  let options = {};
  let optionalServices = [0xec00]
  
  // 蓝牙扫描过滤
  filters = [
    {services:[0xec00]},
    // {namePrefix:"MRobot"}
  ]
  options.optionalServices = optionalServices
  options.filters = filters

  console.log('Requesting Bluetooth Device...');
  navigator.bluetooth.requestDevice(options)
  .then(device => {
    console.log('> Name:             ' + device.name);
    console.log('> Id:               ' + device.id);
    console.log('> Connected:        ' + device.gatt.connected);
    console.log("connecting to GATT server")
    return device.gatt.connect()
  })
  .then(server => {
    console.log("getting service")
    return server.getPrimaryServices()})
  .then(services => {
    console.log("getting characteristics")
    return services[0].getCharacteristics()
  })
  .then(characteristics => {
    characteristics.forEach(element => {
      // 判断这个特征是否为wifi属性
      if(element.uuid.search("ec0e") != -1) {
        wifiCharacteristic = element
      } else {
        ipCharacteristic = element
      }
    });
  })
  .catch(error => {
    console.log('Argh! ' + error);
  });
}

// 将字符串转换为ArrayBuffer
function str2Buffer(str) {
  return new TextEncoder().encode(str)
}

function connectWifi(){
    const pwdStr = document.getElementById("pwd").value
    const ssidStr = document.getElementById("ssid").value
    var dataObj = { "ssid":ssidStr, "pwd":pwdStr};
    const dataStr = JSON.stringify(dataObj)
    console.log(dataStr)
    const dataBuffer = str2Buffer(dataStr)

    wifiCharacteristic.writeValueWithResponse(dataBuffer)

    console.log("wifi名称:" + ssidStr)
    console.log("wifi密码:" + pwdStr)
}

function getIPAddr(){
  ipCharacteristic.readValue().then(value=>{
     let decoder = new TextDecoder('utf-8');
     document.getElementById("ipAddr").innerText = decoder.decode(value)
  });
}
</script>
</html>